{% extends "cp/_cp_layout.html.twig" %}

{% set page_title = 'Uploads - AdminCP' %}

{% block page %}

{% include 'core/_breadcrumb.html.twig' with {
    items: [
        { label: 'Control Panel', url: '/account' },
        { label: 'Uploads', url: '/admin/uploads' },
    ],
    add_back_button: false
} %}

{# Server Info #}
<div class="content-box bg-keeper bd-keeper">
    <div class="content-header">
        <h2>Uploads</h2>
    </div>
    <div class="content-body" id="upload-content-body">

        {# Upload progress bar #}
        <div class="progress mb-3 bg-dark" id="upload-progress-wrapper">
            <div
                id="upload-progress-bar"
                class="progress-bar progress-bar-striped progress-bar-animated"
                role="progressbar"
                style="width: 0%"
                aria-valuenow="0"
                aria-valuemin="0"
                aria-valuemax="100">
                0%
            </div>
        </div>

        {# Upload form #}
        <form action="/admin/uploads/upload" method="POST" enctype="multipart/form-data" id="moderate-edit-workshop-file-form">

            <input type="hidden" name="{{ csrf.keys.name }}" value="{{ csrf.name }}" />
            <input type="hidden" name="{{ csrf.keys.value }}" value="{{ csrf.value }}" />

            <div class="row" style="margin-bottom: 30px;">
                <div class="col-sm-10">
                    <div class="form-group">
                        <label for="workshop-file">
                            File
                            <span class="text-danger">
                                *
                            </span>
                        </label>
                        <input type="file" class="form-control" id="workshop-file" name="file" required>
                        <div class="form-group mt-1">
                            <span class="text-muted" style="font-size: 12px;">Maximum filesize: {{ globals.upload_limit.file.formatted }}</span>
                        </div>
                    </div>
                </div>
                <div class="col-sm-2" style="padding-top: 35px;">
                    <button type="submit" class="btn btn-medieval" style="width: 100%;">Upload</button>
                </div>
            </div>

        </form>

        {% if files|length == 0 %}
            <p>
                No files uploaded.
            </p>
        {% else %}

            <table class="table">

                <thead>
                    <tr>
                        <th>Filename</th>
                        <th>Size</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for file in files %}
                        <tr>
                            <td style="vertical-align: middle;">
                                <a href="/uploads/{{ file.filename|url_encode }}">
                                    {{ file.filename }}
                                </a>
                            </td>
                            <td style="vertical-align: middle;">
                                {{ file.size|format_bytes }}
                            </td>
                            <td style="vertical-align: middle;">
                                {{ file.date|date('Y-m-d ~ G:i') }}
                            </td>
                            <td style="vertical-align: middle;">

                                {# Copy #}
                                <a class="btn btn-sm btn-medieval" data-copy-url="{{ get_env('APP_ROOT_URL') }}/uploads/{{ file.filename|url_encode }}" href="#" style="display:none;">
                                    <ion-icon name="copy-outline"></ion-icon>
                                </a>

                                {# Delete #}
                                <a class="btn btn-sm btn-medieval btn-medieval-gray" href="/admin/uploads/{{ file.filename|url_encode }}/delete/{{ csrf.name }}/{{ csrf.value|url_encode }}">
                                    <ion-icon name="trash-outline"></ion-icon>
                                </a>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>

        {% endif %}

    </div>
</div>

{% endblock %}

{% block body_javascript %}
<script>
$(function () {

    // Show copy buttons on initial load
    $('[data-copy-url]').show();

    // Delegated click handler (works after DOM replacement)
    $(document).on('click', '[data-copy-url]', function (e) {
        e.preventDefault();

        let url = $(this).data('copy-url');
        navigator.clipboard.writeText(url);

        toastr.info('URL copied!');
    });

    // Upload form handler
    $(document).on('submit', '#moderate-edit-workshop-file-form', function (e) {
        e.preventDefault();

        let form = this;
        let formData = new FormData(form);

        $.ajax({
            url: form.action,
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            xhr: function () {
                let xhr = new window.XMLHttpRequest();

                xhr.upload.addEventListener('progress', function (evt) {
                    if (evt.lengthComputable) {
                        let percent = Math.round((evt.loaded / evt.total) * 100);

                        $('#upload-progress-bar')
                            .css('width', percent + '%')
                            .attr('aria-valuenow', percent)
                            .text(percent + '%');
                    }
                }, false);

                return xhr;
            },
            success: function (response) {

                $('#upload-progress-bar')
                    .removeClass('progress-bar-animated')
                    .addClass('bg-success')
                    .text('Upload complete');

                let newHtml = $('<div>').html(response);
                let newContent = newHtml.find('#upload-content-body');

                if (newContent.length) {

                    $('#upload-content-body').replaceWith(newContent);

                    // Ensure copy buttons inside new content are visible
                    $('#upload-content-body').find('[data-copy-url]').show();

                    toastr.success("File successfully uploaded!");

                } else {
                    console.error('No #upload-content-body found in response');
                    toastr.error("Upload failed");
                }
            },
            error: function () {
                $('#upload-progress-bar')
                    .removeClass('progress-bar-animated')
                    .addClass('bg-danger')
                    .text('Upload failed');
            }
        });
    });

});
</script>
{% endblock %}
